# Codex Key Manager 设计说明

> 最后更新：2025-11-05

本文档概述 Codex Key Manager 的目标、核心能力与架构设计，帮助贡献者快速理解代码结构与主要流程。

---

## 1. 项目目标

Codex Key Manager 希望解决以下痛点：

- 同时维护多个 Codex / OpenAI API Key 时，人工切换与记录繁琐。
- 不同环境（开发 / 测试 / 生产）需要加载截然不同的 `config.toml` 配置。
- 团队成员希望共享一套受控的密钥信息与备份策略。

工具以命令行为主，强调 **快速切换、集中配置、离线可控**，并将复杂操作封装为可审计的流程。

---

## 2. 核心功能

1. **密钥全生命周期管理**  
   支持新增、导入、导出、查看、删除等操作，自动跟踪激活状态与使用时间。

2. **一键切换工作环境**  
   通过 `ckm switch` 调整当前激活 Key，并同步写入 Codex 官方配置文件。

3. **标签与备注**  
   每个 Key 可附加标签与描述，便于按照业务或环境进行快速筛选。

4. **远程备份**  
   集成 Backblaze B2，同步密钥清单到对象存储，方便跨机器共享或灾备。

5. **自动化发布**  
   提供 GitHub Actions workflow 与本地 `scripts/release.sh`，在打 tag 时生成 Linux 可执行文件和校验文件。

---

## 3. 架构概览

```
cmd/                 # CLI 子命令
  add.go             # 添加新 Key
  list.go            # 输出 Key 列表
  remove.go          # 删除 Key
  switch.go          # 切换激活 Key 并同步 Codex 配置
  show.go            # 查看详情或指定字段
  update.go          # 更新名称 / 标签 / 配置片段
  remote.go          # B2 同步：init/push/pull/delete
  export.go          # 导出当前配置
  import.go          # 导入配置文件
  codex_config.go    # 与 Codex config.toml 互转

internal/
  config/            # 配置模型与持久化
    config.go        # Manager，Key CRUD，存储抽象
    storage.go       # FileStorage / MemoryStorage
    remote.go        # 远程同步配置结构
  display/           # 终端渲染
    table.go         # 表格与详情视图
    color.go         # 统一颜色与脱敏工具
  integration/codex/ # 与 Codex CLI 配置交互
  logging/           # 日志初始化
  remote/            # Backblaze B2 客户端
  utils/             # 时间、人性化格式化工具

cmd/ckm/main.go      # 程序入口
scripts/release.sh   # 本地自动发布脚本
.github/workflows/   # CI / Release 配置
```

---

## 4. 配置模型

### 4.1 存储路径

默认配置文件保存在 `~/.codex-switch/config.json`，可通过 `--config` 或 `CKM_CONFIG` 变量覆盖。

### 4.2 JSON 结构示例

```json
{
  "version": "1.1.0",
  "active_key_id": "1",
  "keys": [
    {
      "id": "1",
      "name": "主力账号",
      "api_key": "sk-xxx",
      "base_url": "https://api.openai.com/v1",
      "type": "openai",
      "description": "日常开发使用",
      "created_at": "2025-10-01T08:00:00Z",
      "last_checked": "2025-11-04T09:00:00Z",
      "last_used": "2025-11-05T02:30:00Z",
      "active": true,
      "tags": ["prod", "team-a"],
      "raw_config": "[Codex 原始配置片段]"
    }
  ],
  "last_updated": "2025-11-05T02:30:10Z",
  "next_id": 2,
  "remote": {
    "provider": "b2",
    "bucket_name": "codex-key-backup",
    "key_id": "xxxx",
    "application_key": "yyyy",
    "object_key": "default",
    "enabled": true
  }
}
```

解析规则：
- 旧版本 JSON 中的额度字段将被忽略；无需额外迁移。
- `raw_config` 允许存放从 Codex 抽取的完整配置片段。
- `remote` 节点控制远程备份；为空则视为未开启。

---

## 5. 关键流程

### 5.1 新增密钥
1. CLI 解析参数并加载配置管理器 `config.Manager`；
2. 校验名称与 API Key；读取 `--config-file` 把原始配置写入 `raw_config`；
3. Manager 负责生成 ID、补全创建时间与默认字段；
4. 保存到本地 JSON，并在输出中给出成功提示。

### 5.2 列表与筛选
`ckm list` 通过 `display.PrintKeyTable` 输出表格，包含状态、名称、类型、标签、最后使用时间等信息，并在末尾总结激活 Key。

### 5.3 切换激活 Key
1. 查找目标 ID 或名称；
2. 更新 `active_key_id` 与 Key 的 `Active` 标记，刷新 `LastUsed`；
3. `integration/codex` 模块把选中的 Key 写入 Codex 官方配置；
4. 在终端输出成功信息。

### 5.4 远程同步
- `ckm remote init`：配置 Backblaze B2 凭据与档案名。
- `ckm remote push`：序列化配置为 JSON，上传到 B2。
- `ckm remote pull`：从 B2 下载最新配置并替换本地文件。
- `ckm remote delete`：删除云端快照及本地缓存。

所有命令都会记录日志，便于追踪谁在何时操作。

### 5.5 发布流程
- GitHub Actions 在推送 `v*` 标签时运行 `.github/workflows/release.yml`。
- Workflow 构建 Linux/amd64 二进制、打包并生成 SHA256 校验文件。
- 使用 `softprops/action-gh-release` 发布 Release 资产。
- 本地脚本 `scripts/release.sh <tag> [notes]` 提供同等能力，方便正式发布前的演练。

---

## 6. 命令速览

| 命令 | 说明 |
| ---- | ---- |
| `ckm add` | 新增 Key，并导入 Codex 原始配置 |
| `ckm list [--format json]` | 查看 Key 列表，支持 JSON 输出 |
| `ckm show [--id/--name]` | 查看当前或指定 Key 的详情/字段 |
| `ckm switch <ID\|NAME>` | 切换激活 Key 并同步 Codex 配置 |
| `ckm update --id <id>` | 更新名称、API Key、标签或配置片段 |
| `ckm remove <id>` | 删除指定 Key |
| `ckm export [--format json]` | 导出当前配置，便于备份 |
| `ckm import --file <path>` | 导入配置文件并覆盖本地记录 |
| `ckm remote init/push/pull/delete` | 配置并使用远程备份 |

---

## 7. 安全与日志

- 配置文件默认权限为 `0600`，防止其他用户读取。
- 终端输出会对 API Key 做脱敏处理（只保留前 4 / 后 3 位）。
- 日志写入 `~/.codex-switch/logs/ckm.log`，记录关键操作结果。
- 不再尝试自动获取官方额度，避免要求 Admin Key 造成的安全风险。

---

## 8. 贡献指南摘要

- 新贡献前请阅读仓库根目录的 `CONTRIBUTING.md` 与 `CODE_OF_CONDUCT.md`。
- 对于命令或配置的变更，需要同步更新 README 与本文档。
- 提交前执行 `go test ./...`，必要时附加手动验证步骤。

---

## 9. 后续演进方向

1. **多平台构建**：在 Release 工作流中加入 macOS / Windows 产物。
2. **配置加密**：基于本地 KMS 或操作系统钥匙串，对 API Key 做静态加密。
3. **更灵活的远程存储**：抽象 B2 客户端，支持 S3、Azure Blob 等实现。
4. **团队协作增强**：考虑在列表命令中显示最近变更操作人、支持审核日志导出。

---

如需了解实现细节，可从 `internal/config` 与 `cmd/` 目录着手阅读；有任何建议欢迎通过 Issue 或 PR 交流。
