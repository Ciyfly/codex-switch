# Codex Key Manager 设计方案

## 一、项目概述

### 1.1 项目目标
开发一个命令行工具,用于管理多个 Codex API Key 的配置、切换和额度监控,提供美观的彩色终端界面。

### 1.2 核心特性
- 多 Key 管理(增删改查)
- 支持 OpenAI 和 CRS 两种 API 类型
- 额度查询与监控(日/周/月/不限时)
- 配置文件持久化
- 彩色终端输出
- 简单易用的命令行界面

---

## 二、技术架构

### 2.1 技术栈
- **语言**: Go 1.20+
- **核心依赖**:
  ```
  github.com/spf13/cobra          # 命令行框架
  github.com/fatih/color          # 彩色输出
  github.com/olekukonko/tablewriter  # 表格展示
  github.com/schollz/progressbar/v3  # 进度条
  ```

### 2.2 项目结构
```
codex-manager/
├── cmd/
│   ├── root.go          # 根命令
│   ├── add.go           # 添加 Key
│   ├── list.go          # 列出所有 Key
│   ├── remove.go        # 删除 Key
│   ├── switch.go        # 切换当前 Key
│   ├── show.go          # 显示详情
│   ├── check.go         # 检查额度
│   └── export.go        # 导出配置
├── internal/
│   ├── config/
│   │   ├── config.go    # 配置管理
│   │   └── storage.go   # 持久化
│   ├── api/
│   │   ├── openai.go    # OpenAI API 客户端
│   │   └── crs.go       # CRS API 客户端
│   └── display/
│       ├── table.go     # 表格渲染
│       └── color.go     # 颜色主题
├── go.mod
├── go.sum
├── main.go
└── README.md
```

---

## 三、数据模型

### 3.1 配置文件结构
**存储位置**: `~/.codex-manager/config.json`

```json
{
  "version": "1.0.0",
  "active_key_id": "key-001",
  "keys": [
    {
      "id": "key-001",
      "name": "主力账号",
      "api_key": "sk-xxx",
      "base_url": "https://api.openai.com/v1",
      "type": "openai",
      "quota_type": "monthly",
      "quota_limit": 100.0,
      "quota_used": 35.5,
      "description": "用于日常开发",
      "created_at": "2025-01-15T10:30:00Z",
      "last_checked": "2025-11-03T08:20:00Z",
      "last_used": "2025-11-03T08:20:00Z",
      "active": true,
      "tags": ["production", "dev"]
    }
  ],
  "last_updated": "2025-11-03T08:20:00Z"
}
```

### 3.2 数据字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 唯一标识符(UUID) |
| name | string | 显示名称 |
| api_key | string | API Key(加密存储) |
| base_url | string | API 端点 URL |
| type | enum | openai / crs |
| quota_type | enum | daily / weekly / monthly / unlimited |
| quota_limit | float64 | 额度上限(美元) |
| quota_used | float64 | 已使用额度 |
| description | string | 备注信息 |
| created_at | timestamp | 创建时间 |
| last_checked | timestamp | 最后检查时间 |
| last_used | timestamp | 最后使用时间 |
| active | bool | 是否为当前激活 |
| tags | []string | 标签(可选) |

---

## 四、API 额度查询方案

### 4.1 OpenAI API
**端点**: `GET https://api.openai.com/v1/usage?date=YYYY-MM-DD`

**请求头**:
```
Authorization: Bearer sk-xxx
```

**响应示例**:
```json
{
  "object": "list",
  "daily_costs": [
    {
      "timestamp": 1698883200,
      "line_items": [
        {
          "name": "GPT-4",
          "cost": 12.50
        }
      ]
    }
  ],
  "total_usage": 35.50
}
```

### 4.2 CRS 自定义 API
**方案一**: 使用 `/v1/dashboard/billing/usage` 端点(如果支持)

**方案二**: 通过配置文件手动配置,定期手动更新
```json
{
  "type": "crs",
  "manual_tracking": true,
  "quota_used": 20.0
}
```

### 4.3 额度计算逻辑
```go
// 根据 quota_type 计算剩余额度
func CalculateRemaining(key KeyConfig) float64 {
    remaining := key.QuotaLimit - key.QuotaUsed
    
    // 检查是否需要重置(日/周/月)
    if ShouldReset(key.QuotaType, key.LastChecked) {
        remaining = key.QuotaLimit
    }
    
    return remaining
}

// 判断是否需要重置额度
func ShouldReset(quotaType QuotaType, lastChecked time.Time) bool {
    now := time.Now()
    switch quotaType {
    case QuotaDaily:
        return !IsSameDay(now, lastChecked)
    case QuotaWeekly:
        return !IsSameWeek(now, lastChecked)
    case QuotaMonthly:
        return !IsSameMonth(now, lastChecked)
    default:
        return false
    }
}
```

---

## 五、命令行界面设计

### 5.1 命令结构
```
ckm (Codex Key Manager)
├── add         添加新 Key
├── list        列出所有 Key
├── show <id>   显示 Key 详情
├── remove <id|name> 删除 Key
├── switch <id|name> 切换当前 Key
├── check       检查当前 Key 额度
├── check-all   检查所有 Key 额度
├── update <id> 更新 Key 配置
├── export      导出配置到文件
├── import      从文件导入配置
├── codex-config 同步 Codex 配置与认证
└── version     显示版本信息
```

### 5.2 命令详细设计

#### 5.2.1 添加 Key
```bash
ckm add \
  --name "生产环境" \
  --key "sk-xxx" \
  --quota-type monthly \
  --tags prod,main \
  --config-file /path/to/config.toml
```

**输出示例**:
```
✓ 成功添加 API Key
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ID:          key-abc123
  名称:        生产环境
  类型:        OpenAI
  额度:        $100.00 / 月
  状态:        ✓ 已激活
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**提示**:
- `--config-file` 为必填项，工具会读取文件内容并完整替换 Codex `config.toml`，`auth.json` 将根据 Key 自动生成。
- `--quota-type` 支持 `daily`/`weekly`/`monthly`/`yearly`/`unlimited`，缺省为 `monthly`。
- 标签可选，使用逗号分隔；如需后续调整可配合 `ckm update --set-tags`。

#### 5.2.2 列出所有 Key
```bash
ckm list
ckm list --sort usage      # 按使用量排序
ckm list --filter type=openai
ckm list --format json     # JSON 输出
```

**输出示例**:
```
╔════════════════════════════════════════════════════════════════════════════╗
║                         Codex Key Manager - Keys                           ║
╠══════════╦════════════╦══════════╦═══════════╦════════════╦════════════════╣
║   状态   ║    名称    ║   类型   ║  额度类型 ║  使用情况  ║   最后使用     ║
╠══════════╬════════════╬══════════╬═══════════╬════════════╬════════════════╣
║ ● 激活   ║ 生产环境   ║ OpenAI   ║ 月额度    ║ 35.5/100   ║ 2小时前        ║
║          ║            ║          ║           ║ ████░░░    ║                ║
╠══════════╬════════════╬══════════╬═══════════╬════════════╬════════════════╣
║ ○        ║ 测试账号   ║ CRS      ║ 周额度    ║ 8.2/20     ║ 1天前          ║
║          ║            ║          ║           ║ ████░░░    ║                ║
╠══════════╬════════════╬══════════╬═══════════╬════════════╬════════════════╣
║ ○        ║ 备用       ║ OpenAI   ║ 不限时    ║ 120.0/∞    ║ 3天前          ║
║          ║            ║          ║           ║ ━━━━━━━    ║                ║
╚══════════╩════════════╩══════════╩═══════════╩════════════╩════════════════╝

总计: 3 个 Key  |  当前激活: 生产环境  |  本月总消费: $163.70
```

#### 5.2.3 显示详情
```bash
ckm show key-abc123
ckm show             # 显示当前激活的 Key
```

**输出示例**:
```
╔═══════════════════════════════════════════════════════════════════╗
║                        Key 详细信息                                ║
╚═══════════════════════════════════════════════════════════════════╝

  基本信息
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ID:            key-abc123
  名称:          生产环境
  类型:          OpenAI
  状态:          ✓ 激活中
  
  API 配置
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Base URL:      https://api.openai.com/v1
  API Key:       sk-proj-****************************xyz
  
  额度信息
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  类型:          月额度
  限额:          $100.00
  已使用:        $35.50 (35.5%)
  剩余:          $64.50
  
  进度: ███████░░░░░░░░░░░░░░ 35.5%
  
  使用统计
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  创建时间:      2025-01-15 10:30:00
  最后检查:      2025-11-03 08:20:00 (2小时前)
  最后使用:      2025-11-03 08:20:00
  
  标签:          prod, main
  备注:          生产环境专用账号
```

#### 5.2.4 检查额度
```bash
ckm check              # 检查当前 Key
ckm check-all          # 检查所有 Key
ckm check --refresh    # 强制刷新(调用 API)
```

**输出示例**:
```
正在检查额度... ━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100%

╔═══════════════════════════════════════════════════════════════╗
║                       额度检查报告                             ║
╚═══════════════════════════════════════════════════════════════╝

  当前 Key: 生产环境 (key-abc123)
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  
  ✓ API 连接正常
  
  额度状态:
    本月限额:   $100.00
    已使用:     $35.50
    剩余:       $64.50
    
  使用趋势:
    今日:       $2.30
    本周:       $12.80
    本月:       $35.50
    
  ⚠ 预警: 按当前使用速度,预计 18 天后额度用尽
  
  建议: 当前使用正常,额度充足
```

#### 5.2.5 切换 Key
```bash
ckm switch key-abc123
ckm switch --name "测试账号"  # 通过名称切换
```

**输出示例**:
```
✓ 已切换到: 测试账号 (key-xyz789)
  类型: CRS
  剩余额度: $11.80 / $20.00
```

#### 5.2.6 同步 Codex 配置
```bash
ckm codex-config                      # 使用当前激活 Key 同步配置
ckm codex-config --id key-abc123      # 指定 Key ID
ckm codex-config --config /root/.codex/config.toml --auth /root/.codex/auth.json
```

**功能说明**:
- 自动生成差异化配置段(区分 CRS 与其他供应商, 仅替换核心 `base_url` 等字段)
- 保留原有 `[mcp_servers]`、`[projects]` 等段落
- 同步 `/root/.codex/auth.json` 中的 `OPENAI_API_KEY`
- 如需输出自定义模板(如 `ctl`、`azure` 等), 可准备目标 `config.toml` 并执行 `ckm update --set-config-file /path/to/config.toml` 导入后再同步

**输出示例**:
```
✓ 已更新 Codex 配置，使用 Key: 生产环境 (key-abc123)
```

---

## 六、彩色输出设计

### 6.1 颜色主题
```go
// 状态颜色
var (
    ColorActive   = color.New(color.FgGreen, color.Bold)   // 激活状态
    ColorInactive = color.New(color.FgWhite)               // 未激活
    ColorWarning  = color.New(color.FgYellow, color.Bold)  // 警告
    ColorError    = color.New(color.FgRed, color.Bold)     // 错误
    ColorSuccess  = color.New(color.FgGreen)               // 成功
    ColorInfo     = color.New(color.FgCyan)                // 信息
    ColorPrimary  = color.New(color.FgBlue, color.Bold)    // 主要
)

// 额度颜色(根据百分比)
func QuotaColor(percentage float64) *color.Color {
    switch {
    case percentage < 50:
        return color.New(color.FgGreen)
    case percentage < 80:
        return color.New(color.FgYellow)
    default:
        return color.New(color.FgRed)
    }
}
```

### 6.2 进度条样式
```go
// 额度进度条
func RenderProgressBar(used, limit float64, width int) string {
    percentage := used / limit * 100
    filled := int(float64(width) * used / limit)
    empty := width - filled
    
    bar := strings.Repeat("█", filled) + strings.Repeat("░", empty)
    
    // 根据百分比着色
    if percentage < 50 {
        return color.GreenString(bar)
    } else if percentage < 80 {
        return color.YellowString(bar)
    } else {
        return color.RedString(bar)
    }
}
```

### 6.3 表格样式
```go
table := tablewriter.NewWriter(os.Stdout)
table.SetHeader([]string{"状态", "名称", "类型", "额度", "使用率"})
table.SetBorder(true)
table.SetHeaderColor(
    tablewriter.Colors{tablewriter.Bold, tablewriter.FgCyanColor},
    tablewriter.Colors{tablewriter.Bold, tablewriter.FgCyanColor},
    tablewriter.Colors{tablewriter.Bold, tablewriter.FgCyanColor},
    tablewriter.Colors{tablewriter.Bold, tablewriter.FgCyanColor},
    tablewriter.Colors{tablewriter.Bold, tablewriter.FgCyanColor},
)
table.SetColumnColor(
    tablewriter.Colors{tablewriter.FgGreenColor},
    tablewriter.Colors{},
    tablewriter.Colors{},
    tablewriter.Colors{},
    tablewriter.Colors{},
)
```

---

## 七、配置文件管理

### 7.1 配置文件位置
- **Linux**: `~/.codex-manager/config.json`
- **配置目录权限**: `0700`
- **配置文件权限**: `0600` (保护 API Key)

### 7.2 配置加密(可选)
```go
// 使用 AES-256 加密 API Key
func EncryptAPIKey(key string, password string) (string, error) {
    // 实现 AES 加密
}

func DecryptAPIKey(encrypted string, password string) (string, error) {
    // 实现 AES 解密
}
```

### 7.3 配置备份
```bash
ckm export --output backup.json          # 导出配置
ckm export --output backup.json --encrypt  # 加密导出
ckm import --input backup.json           # 导入配置
```

---

## 八、错误处理与日志

### 8.1 错误分类
- **网络错误**: API 请求失败,超时
- **认证错误**: API Key 无效
- **配置错误**: 配置文件损坏,格式错误
- **权限错误**: 文件读写权限不足

### 8.2 日志级别
```
DEBUG   详细调试信息
INFO    常规信息
WARN    警告信息
ERROR   错误信息
```

### 8.3 日志文件
- **位置**: `~/.codex-manager/logs/ckm.log`
- **滚动**: 按天滚动,保留 7 天
- **格式**: `[2025-11-03 08:20:00] [INFO] Message`

---

## 九、高级功能(可选)

### 9.1 自动切换
```bash
# 根据剩余额度自动切换到下一个可用 Key
ckm auto-switch --threshold 10  # 剩余 $10 时自动切换
```

### 9.2 额度预警
```bash
# 设置预警阈值
ckm alert set --threshold 80 --email user@example.com

# 当使用量超过 80% 时发送通知
```

### 9.3 使用统计
```bash
# 查看历史统计
ckm stats --range 30d
ckm stats --export stats.csv
```

### 9.4 批量操作
```bash
# 批量检查
ckm check-all --parallel

# 批量更新
ckm update-all --quota-limit 200
```

### 9.5 远程同步（Backblaze B2）
```bash
# 初始化远程存储（示例凭据，profile 可自定义）
ckm remote init \
  --bucket codex-config \
  --key-id 005851d6c5765c00000000001 \
  --app-key 'K005I8UJg7bKunjXVmuX6bK1G/xZi80' \
  --profile studio

# 推送当前配置快照
ckm remote push --profile studio

# 在另一台机器拉取并更新
ckm remote pull --profile studio

# 删除远程快照并清理本地备份
ckm remote delete --profile studio
```
- 推送内容包含 `ckm add`/`ckm list` 展示的名称、ID、类型、额度类型、API Key 及配置文件内容，统一序列化为 JSON。
- 本地快照存放于 `~/.codex-manager/snapshots/<profile>.json`，文件权限默认为 `0600`。
- 远端对象名即 `<profile>.json`，不同机器只需使用相同 profile 即可访问对应快照。
- B2 凭据属于敏感信息，建议设置环境变量或使用凭据管理工具；泄露时请在 B2 控制台吊销并重新初始化。

---

## 十、安装与使用

### 10.1 安装
```bash
# 从源码编译
go install github.com/yourusername/codex-manager@latest

# 或下载预编译二进制
wget https://github.com/yourusername/codex-manager/releases/latest/download/ckm-linux-amd64
chmod +x ckm-linux-amd64
sudo mv ckm-linux-amd64 /usr/local/bin/ckm
```

### 10.2 初始化
```bash
# 首次运行自动创建配置目录
ckm version

# 添加第一个 Key
ckm add --name "主账号" --key "sk-xxx" --quota-type monthly --config-file /path/to/config.toml
```

### 10.3 快速开始
```bash
# 1. 添加 Key
ckm add --name "主账号" --key "sk-xxx" --quota-type monthly --tags main --config-file /path/to/config.toml

# 2. 查看列表
ckm list

# 3. 检查额度
ckm check

# 4. 切换 Key
ckm switch --name "备用账号"
```

---

## 十一、开发规范

### 11.1 代码风格
- 遵循 Go 官方代码规范
- 使用 `gofmt` 格式化
- 使用 `golangci-lint` 进行代码检查

### 11.2 测试覆盖
- 单元测试覆盖率 > 80%
- 集成测试覆盖核心流程
- Mock API 响应进行测试

### 11.3 文档
- 每个命令提供详细的 `--help` 说明
- README 包含完整的使用示例
- API 文档使用 GoDoc

---

## 十二、性能优化

### 12.1 配置缓存
- 配置文件读取后缓存在内存
- 仅在修改时写入磁盘

### 12.2 并发检查
- 使用 goroutine 并发检查多个 Key
- 限制并发数避免 API 限流

### 12.3 响应时间
- 命令响应时间 < 100ms (不含 API 调用)
- API 调用超时设置 10s

---

## 十三、安全考虑

### 13.1 API Key 保护
- 配置文件权限 `0600`
- 显示时脱敏显示(`sk-****xyz`)
- 可选加密存储

### 13.2 网络安全
- 强制使用 HTTPS
- 验证 SSL 证书
- 支持代理配置

### 13.3 输入验证
- 验证 URL 格式
- 验证 API Key 格式
- 防止路径遍历攻击

---

## 十四、扩展性设计

### 14.1 插件系统(未来)
```bash
# 支持自定义 API 类型
ckm plugin add azure-openai
```

### 14.2 配置导入导出
```bash
# 支持多种格式
ckm export --format yaml
ckm import --format toml
```

### 14.3 集成其他工具
```bash
# 与环境变量集成
eval $(ckm env)  # 导出当前 Key 到环境变量
```

---

## 十五、示例场景

### 场景 1: 日常开发
```bash
# 早上开始工作,检查额度
ckm check

# 使用主账号开发
export OPENAI_API_KEY=$(ckm show --field api_key)

# 晚上检查今日消费
ckm stats --range today
```

### 场景 2: 多项目管理
```bash
# 项目 A 使用生产 Key
ckm switch prod-key

# 项目 B 使用测试 Key  
ckm switch test-key

# 快速查看所有 Key 状态
ckm list
```

### 场景 3: 额度告警
```bash
# 设置预警
ckm alert set --threshold 90 --action switch

# 自动切换到备用 Key
ckm auto-switch --enable
```

---

## 十六、总结

这个方案提供了一个完整的 Codex Key 管理工具设计,具有以下特点:

✅ **功能完整**: 覆盖 Key 管理的所有核心需求
✅ **易于使用**: 简洁的命令行界面,丰富的交互反馈
✅ **美观直观**: 彩色输出,表格展示,进度条可视化
✅ **安全可靠**: 配置加密,权限保护,错误处理
✅ **性能优良**: 缓存优化,并发处理,快速响应
✅ **可扩展**: 模块化设计,易于添加新功能

你可以根据这个方案开始实现,如果需要某个部分的更详细设计,请告诉我!
